<!doctype html>
<html>

<head>
    <title>Zoller C# reference</title>
    <link href="./content/css/chat.css" rel="stylesheet" />
</head>
<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
<script>
    $(function () {
        var itsUser = prompt('your name?');
        var socket = io.connect("http://192.168.16.119:3000");

        $('form').submit(function () {
            socket.emit('chat message', $('#m').val());
            $('#m').val('');
            return false;
        });
        $('#m').on('keyup', function (isTyping) {
            if ($('#m').val())
                isTyping = true;
            else
                isTyping = false;

            socket.emit('user typing', isTyping);
            return false;
        })
        socket.on('connect', function (msg) {
            socket.emit('join', itsUser);
        });

        socket.on('join', function (user) {
            if (itsUser != user)
                $('#messages').append($('<li>' + user + " has joined the room!" + "</li>"));
            else
                $('#messages').append($('<li>' + "Welcome, " + user + "! Enjoy your visit!" + "</li>"));
        });

        socket.on('chat message', function (data) {

            if (itsUser != data.name) {
                $('#messages').append($('<li>' + data.name + ": " + data.msg + "</li>"))
                $('#user-typing').html("");
            } else
                $('#messages').append($('<li>' + "You" + ": " + data.msg + "</li>"))
            //console.log($(window).scrollTop());
            var messagePadding = $('#chat-window').css("padding-bottom");
            var windowHeight = $(window).height();
            var theBottomPadding = messagePadding.substr(0, messagePadding.indexOf('px'));
            var scrollposition = $(window).scrollTop() + windowHeight - $('#m').height() -
                theBottomPadding;

            if (scrollposition < $("#messages li").last().position().top)
                window.scrollTo({
                    top: document.body.scrollHeight,
                    behavior: "smooth"
                })
        });

        socket.on('leave', function (data) {
            $('#messages').append($('<li>' + data.name + " has left the room!" + "</li>"));
        });

        socket.on('user typing', function (data) {
            if (data.typing && data.name != itsUser)
                $('#user-typing').html(data.name + ' is typing...');
            else if (!data.typing && data.name != itsUser) {
                $('#user-typing').html('');
            }
        });
    });
</script>


<body>
    <div id="chat-window">
        <ul id="messages"></ul>
        <div id="user-typing"></div>
    </div>
    <div id="message-area">
        <form action="">
            <input id="m" autocomplete="off" /><button>Send</button>
        </form>
    </div>

</body>

</html>